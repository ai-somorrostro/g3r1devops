# ----------------------------------------
# BLOQUE INPUT
# ----------------------------------------
input {
  file {
    # Path dinámico
    path => "/home/g3/ELS/scrapper_data/manfred_FINAL_*.json"
    
    mode => "read"
    start_position => "beginning"
    sincedb_path => "/home/g3/ELS/sincedb_data/logstash_sincedb"
    delimiter => "%%%END_OF_FILE%%%" 
    file_completed_action => "log" 
    file_completed_log_path => "/home/g3/ELS/scrapper_data/processed_files.txt"
  }
}

# ----------------------------------------
# BLOQUE FILTER (ACTUALIZADO)
# ----------------------------------------
filter {
  # 1. Parseamos el JSON
  json {
    source => "message"
    target => "root_json"
  }

  # 2. Dividimos el array
  split {
    field => "root_json"
  }

  # 3. EXTRAEMOS LOS CAMPOS ANIDADOS (CORRECCIÓN CLAVE)
  ruby {
    code => '
      event_data = event.get("root_json")
      
      if event_data.is_a?(Hash)
        # Mover campos de primer nivel
        event_data.each { |k, v| 
          if k != "details"
            event.set(k, v) 
          end
        }
        
        # Mover campos anidados de "details"
        details = event_data["details"]
        if details.is_a?(Hash)
          details.each { |k, v| event.set(k, v) }
        end
      end
    '
  }

  # 4. LIMPIEZA FINAL: Ahora también eliminamos el campo 'details' original
  mutate {
    remove_field => ["root_json", "message", "details", "event", "log", "host", "@version"]
  }
}

# ----------------------------------------
# BLOQUE OUTPUT
# ----------------------------------------
output {
  elasticsearch {
    hosts => ["https://localhost:9200"]
    index => "jobs_manfred"
    user => "TU_USUARIO_AQUI"
    password => "TU_CONTRASEÑA_AQUI"
    ssl_certificate_authorities => ["/home/g3/ELS/nodo1/elasticsearch-9.2.1/config/certs/http_ca.crt"]
    ssl_verification_mode => "full"
    document_id => "%{id}"
  }

  stdout { codec => rubydebug }
}